# 项目过程

#### State类

处理函数（纯虚函数）



##### Context 环境类（上下文）

函数成员

1. 设置状态
2. 请求
3. 获取状态



#### CustomDialog 具体状态类

设置3种状态（开始，运行，待机）

重写三种不同状态下的处理函数

##### 开始状态

播放视频，结束后，发送请求，将状态改变为运行状态

##### 运行状态

让主界面显示，且定时5秒，当5秒内未操作，进入待机状态

##### 待机状态

黑屏，等待触摸事件唤醒



#### appbt.h

设置字体样式，初始化样式

重写`paintEvent`，绘制图片，设置动态缩放图片适应按钮大小

重写`mousePressEvent`，鼠标按下事件，判断左键按住，更新样式

重写`mouseReleaseEvent`，鼠标释放事件，同理

鼠标更新样式函数`updateStyle`，判断其标志位来更改样式，如`m_disabled`，`m_pressed`，默认



#### xxxbt.h(按钮子类)-继承于appbt.h

按钮过多就不全部展示

GPSbt.h

重写鼠标按下事件，发送按住信号，最后在调用基类的鼠标按下事件

重写鼠标释放事件，发送释放与点击信号，同理

两个信号（按住与释放）



#### VideoPlayer类（开机动画）

基于`FFmpeg`外部库

`playVideo`函数：显示动画

1. 定义存储视频数据、判断是否为视频流、存储视频流索引等变量的指针和整数。
2. 创建AVFormatContext（容器格式的上下文）
3. 初始化pFormatCtx（打开输入文件或输入流）
4. 获取音视频流数据信息
5. 找到视频流的索引：遍历所有流，找到视频流的索引
6. 获取视频流编码
7. 查找解码器，初始化pAVctx，将解码器填入pAVctx
8. 将获取到的视频数据经过RGB转换
9. 解码后，获取每一帧的视频画面，通过QTimer定时器timeout信号，读取视频帧，显示在QLable上



#### EmailSender类（救援邮件）

初始化QTcpSocket对象，定义了`onConnected`和`onReadyRead`两个槽函数

初始化`QStringList commands`，将连接成功时的信号存入该容器中，之后通过`sendCommand`函数发送每一条信号

onConnected槽函数：当连接成功时，QTcpSocket会发送connected信号，之后处理槽函数

同理onReadyRead槽函数：当连接成功时，QTcpSocket会发送ReadyRead信号，之后处理槽函数

sendEmail函数：发送电子邮件，发送人，密钥，对方邮箱，主题，内容；



#### HttpWeather类（天气类）

发送请求函数，将初始化url变量，将url设置给请求头，最后通过http对象将请求头发送

设置两个连接，发送请求后，等待服务端回应，通过`finished`信号，连接槽函数（读取数据）

设置定时器，因为要实时获取时间数据，获取系统日期其格式为`yyyy-MM-dd`，时间为`hh:mm`，且通过dayofweek函数获取星期几



#### MusicPlayer类（音乐播放器）

基于QtMultimedia（Qt多媒体）

初始化播放器对象，获取音频输出设备

连接3个 `player` 的信号和槽：

播放源时长变化时的响应。更新进度显示

播放位置变化时的响应。更新进度显示

元数据变化时的响应。显示歌曲图片

##### 按钮槽函数

播放、暂停、停止、上一首、下一首

双击切换歌曲、清空列表歌曲、音量、循环、倍数、关闭、移除



#### PaidClient类（流量充值登录）

##### 注册

获取ui中两个单行框中的数据

判断数据是否为空，空则弹出警告

将密码进行MD5加密，之后存储于数据库（Qt自带）中

##### 登录

获取ui界面中的数据，将ui数据与数据库中的数据进行对比，若成功则进入下一个界面Paid，若失败则弹出警告

同理也设置了数据为空，弹出警告

#### 注意

因为下一个界面需要改界面数据，此时调用paid类中的公有`sendInfo`函数，将数据传入paid（正向传递数据）



#### Paid类（流量充值）

获取数据，将数据存入数据库中

充值流量时，将充值的数据与当前数据相加并显示

充值时，显示二维码，进行扫码支付。



#### CustomDialog类（座椅调节）

设置3个按钮，+ 、 - 、退出

+与- 按钮按下时，启动定时器，通过定时器QTimer的timeout信号，增加数值

设置按下，释放时，按钮的不同样式



#### WebClass类

定义了城市，当前城市，终点城市

City函数：返回当前城市名称

setCity函数：设置新城市名称

searchResult函数：返回搜索结果（JSON格式）

setSearchResult：设置当前城市与新城市是否相同，相同则不执行操作，不相同则将新城市设置为当前城市，并发送`cityChanged`信号（城市改变）



#### Webmap类（地图导航）

设置Qt WebEngine的环境变量，以便远程调试

创建`WebClass`对象，该对象用于与JavaScript进行通信。

创建一个`QWebChannel`对象，用于与JavaScript进行通信。

将`webObj`对象注册到QWebChannel中，以便在JavaScript中使用。

创建QWebView对象，将HTML数据显示。

将QWebChannel设置为`webView`的页面。



###### 连接3个槽函数

1. 从UI界面上获取数据，当该数据改变时，将数据传入web对象中
2. 当UI中的位置搜索Edit（文本）改变时，将其数据存入QString 对象中，发送给JS脚本，将搜索关键字传递给WebView对象，并显示；
3. 当搜索结果发生改变时，将结果放入`setPositionList`函数中解析JSON数据并更新UI 界面中的 `positionListWidget`。



##### 函数成员

###### on_setCityBt_clicked（设置城市按钮）

将UI界面的cityNameEdit中的文本传入webObj对象中

###### setPositionList（显示列表）

获取目标文本，将目标文本在web对象中遍历，获取与目标文本相关的地点文本，并显示在QListWidget上

###### on_startNavBt_clicked（导航按钮）

判断起始点与终点是否已经被设置，没有则弹出提示框

将两点数据传入webObje对象指向JS导航脚本，重置按钮文本，开始导航-》停止导航，当点击停止导航，清除导航脚本

###### on_setStartPostionBt_clicked（设置起始点按钮）

定义两个变量，选中索引，起始点坐标，并对其初始化

选中项的索引负责获取该索引下的Json数据，最后赋值给起点坐标

###### on_setEndPostionBt_clicked（设置终点按钮）

同理，定义了选中索引（int），终点坐标，并初始化

选中项的索引负责获取该索引下的Json数据，最后赋值给终点坐标





## 问题

###### 1、开始模式时，视频播放对象，结束后才释放

解决办法：将全部内容放入mainWindow上封装为一个函数



###### 2、待机模式，设置全部按钮不能点击，且黑屏

解决办法：

1. 将一个QLable对象（幕布）样式改为黑色，且置于主界面前面，默认情况下隐藏，当定时器达到时，显示幕布
2. 编写鼠标按住事件，若鼠标按住后释放，则定时器开启，幕布隐藏



###### 3、按钮触发错乱

因设置了一个按钮基类，用于设置其在不同按钮下的不同样式，由于自身经验不足，导致连接信号，不知道是子类还是基类的信号

解决办法：基类按钮只实现不同事件下的样式，通过标志位来判断是默认，按住，释放状态，并由改变样式函数实现

而子类按钮实现发送点击、按住、释放信号，通过不同的信号告知主界面连接槽函数



###### 4、多界面的数据传输

正向传递数据，可以在下一个界面中写一个公有成员函数，用来接收数据 

逆向传递数据，通过发送信号的方式该信号中有参数，而收取数据的界面需要写一个槽函数来接收数据



###### 5、连接函数connect的运用

想要获取对象的参数，可以通过sender（）函数在 槽函数中获取其对象的数据





